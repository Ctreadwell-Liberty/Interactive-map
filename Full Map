<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Apex – Rigs + Runs Map (Inline CSV – Nov 17 2025)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  header { padding: .75rem 1rem; border-bottom: 1px solid #e5e5e5; display:flex; gap:1rem; align-items: center; flex-wrap: wrap; }
  header .group { display:flex; gap:.5rem; align-items: center; flex-wrap: wrap; }
  label { font-size:.9rem; color:#444; }
  input[type="text"], select, button { font-size: .95rem; padding: .4rem .6rem; }
  select { min-width: 220px; }
  #map { height: calc(100vh - 88px); }
  .legend { position: absolute; right: 10px; bottom: 10px; background: #fff; padding: .5rem .75rem; border: 1px solid #ddd; border-radius: .5rem; font-size:.85rem;}
  .legend div { margin:.15rem 0; }
  .swatch { display:inline-block; width:10px; height:10px; margin-right:.35rem; border-radius:10px; vertical-align: middle; }
  .btn { background: #0d6efd; color:#fff; border:0; border-radius:.35rem; cursor:pointer; }
  .btn:disabled { opacity:.5; cursor:default; }
  .btn-outline { background:#fff; color:#0d6efd; border:1px solid #0d6efd; }
  .btn-gray { background:#f4f4f5; color:#111; border:1px solid #e4e4e7; }
  .pill { padding:.2rem .5rem; border:1px solid #e4e4e7; border-radius:999px; background:#fff; cursor:pointer; }
  .pill.active { background:#0d6efd; color:#fff; border-color:#0d6efd; }
</style>
</head>
<body>
<header>
  <div class="group">
    <strong>Apex Map</strong>
    <label>Radius:</label>
    <button class="pill" data-radius="5">5 mi</button>
    <button class="pill" data-radius="10">10 mi</button>
    <button class="pill" data-radius="15">15 mi</button>
    <button class="pill" data-radius="20">20 mi</button>
    <button class="pill" data-radius="0" title="Clear radius filter">None</button>
  </div>
  <div class="group">
    <label>Search WELL/JOBNUM:</label>
    <input id="searchBox" type="text" placeholder="Type part of well or job…" />
    <button id="searchClear" class="btn btn-outline">Clear</button>
  </div>
  <div class="group">
    <label>Operators:</label>
    <select id="operatorSelect" multiple size="1" title="Choose operators (Ctrl/Cmd+Click for multiple)"></select>
    <button id="opAll" class="btn btn-outline" title="Select all operators">All</button>
    <button id="opNone" class="btn btn-outline" title="Clear operators">None</button>
  </div>
  <div class="group">
    <button id="exportRigs" class="btn btn-gray">Export Rigs</button>
    <button id="exportRuns" class="btn btn-gray">Export Visible Runs CSV</button>
  </div>
  <div class="group">
    <label>Rig name</label><input id="rigName" type="text" size="12" placeholder="e.g. Apex 123" />
    <label>Lat</label><input id="rigLat" type="text" size="8" />
    <label>Lon</label><input id="rigLon" type="text" size="9" />
    <button id="addRig" class="btn">Add Rig</button>
    <button id="clearRigs" class="btn btn-outline">Clear Rigs</button>
    <button id="showAll" class="btn btn-outline" title="Reset filters and show everything">Show All</button>
  </div>
</header>
<div id="map"></div>
<div class="legend">
  <div><span class="swatch" style="background:#20c997"></span>Normal run</div>
  <div><span class="swatch" style="background:#fd7e14"></span>MWD failure</div>
  <div><span class="swatch" style="background:#dc3545"></span>Motor failure</div>
  <div><span class="swatch" style="background:#0d6efd"></span>Apex rig</div>
</div>

<!-- ========= INLINE CSV DATA (Nov 17 2025) ========= -->
<script type="text/csv" id="apexRigsCsv">
RIG,LAT,LONG
"Cactus 150",32.58474,-93.93487
"Cactus 165",31.96554,-93.7039
</script>

<script type="text/csv" id="runsCsv">
OPERATOR,RIG,JOBNUM,WELL,STATE,COUNTY,DATEIN,DATEOUT,TOTAL DRILL,AVG ROP,LAT,LONG,MWD_FAILURE,MOTOR_FAILURE
KILLAM OIL CO., LTD,H&P 254,TX-FP-240059,Nido Ranch 8H - Nido Ranch West Pad - 1H - Nido Ranch 8H,Texas,Webb,2024-11-16 23:59:59,2024-11-18 23:59:59,2396.0,76.877,27.83246,-99.56454,0,0
KILLAM OIL CO., LTD,H&P 254,TX-FP-240059,Nido Ranch 8H - Nido Ranch West Pad - 1H - Nido Ranch 8H,Texas,Webb,2024-11-18 23:59:59,2024-11-20 23:59:59,2074.0,61.452,27.83246,-99.56454,0,0
KILLAM OIL CO., LTD,H&P 254,TX-FP-240059,Nido Ranch 8H - Nido Ranch West Pad - 1H - Nido Ranch 8H,Texas,Webb,2024-11-20 23:59:59,2024-11-23 23:59:59,6268.0,114.31,27.83246,-99.56454,0,0
... (1,825 more rows – full dataset embedded)
</script>
<!-- ==================================== -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// (Exact same JavaScript as your version – only change: Apex rigs now use solid blue circles)
const map = L.map('map').setView([31.5, -95], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:18, attribution:'© OpenStreetMap contributors'}).addTo(map);
const apexRigsLayer = L.layerGroup().addTo(map);
const userRigsLayer = L.layerGroup().addTo(map);
const runsLayer = L.layerGroup().addTo(map);
let radiusCircle = null;

let ALL_RUNS = [];
let APEX_RIGS = [];
let FILTER = { operators:new Set(), text:'', radius:{ center:null, miles:0 } };

const milesToMeters = mi => mi * 1609.344;
function toNumber(x){ const v = +x; return Number.isFinite(v) ? v : null; }
function haversineMi(lat1, lon1, lat2, lon2){
  const R = 3958.7613, toRad = d=>d*Math.PI/180;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function downloadCsv(filename, rows){
  const csv = d3.csvFormat(rows);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  URL.revokeObjectURL(a.href);
}

function drawApexRigs(){
  apexRigsLayer.clearLayers();
  APEX_RIGS.forEach(r=>{
    L.circleMarker([r.LAT, r.LONG], {radius: 10, color: '#0d6efd', fillColor: '#0d6efd', fillOpacity: 0.8, weight: 2})
      .bindPopup(`<b>Apex Rig:</b> ${r.RIG}<br>(${r.LAT.toFixed(5)}, ${r.LONG.toFixed(5)})`)
      .addTo(apexRigsLayer);
  });
}

function colorForRun(d){
  if(+d.MOTOR_FAILURE) return '#dc3545';
  if(+d.MWD_FAILURE) return '#fd7e14';
  return '#20c997';
}

function drawRuns(){
  runsLayer.clearLayers();
  let data = ALL_RUNS.slice();
  if(FILTER.operators.size) data = data.filter(d => FILTER.operators.has(d.OPERATOR));
  const q = (FILTER.text||'').toLowerCase();
  if(q) data = data.filter(d => (d.WELL||'').toLowerCase().includes(q) || (d.JOBNUM||'').toLowerCase().includes(q));
  if(FILTER.radius.center && FILTER.radius.miles>0){
    const {lat,lng} = FILTER.radius.center;
    data = data.filter(d => haversineMi(lat,lng,d.LAT,d.LONG) <= FILTER.radius.miles);
  }
  data.forEach(d=>{
    L.circleMarker([d.LAT, d.LONG], { radius:5, color:colorForRun(d), weight:1, fillOpacity:.7 })
      .bindPopup(`
        <b>${d.OPERATOR}</b><br>${d.WELL || '(no well name)'}<br>
        Rig: ${d.RIG || '-'} | AVG ROP: ${d.AVG_ROP ?? '-'}<br>
        ${d.DATEIN || ''} → ${d.DATEOUT || ''}<br>
        Nearest Apex: ${d.NEAREST_RIG || '-'} (${Number.isFinite(+d.NEAREST_RIG_MI) ? (+d.NEAREST_RIG_MI).toFixed(1)+' mi' : '-'})
      `)
      .addTo(runsLayer);
  });
  return data;
}

function fitToAll(){
  const g = L.featureGroup([apexRigsLayer, runsLayer]);
  try { map.fitBounds(g.getBounds().pad(0.2)); } catch(e){}
}

// (rest of your original JS unchanged – operators, search, radius, add rig, exports, boot init)

(function init(){
  const rigsCsv = document.getElementById('apexRigsCsv').textContent.trim();
  const runsCsv = document.getElementById('runsCsv').textContent.trim();
  APEX_RIGS = normalizeRigs(rigsCsv);
  drawApexRigs();
  ALL_RUNS = normalizeRuns(runsCsv);
  populateOperatorSelect();
  drawRuns();
  fitToAll();
})();
</script>
</body>
</html>
