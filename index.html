<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Apex – Rigs + Runs Map (Inline CSV)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  header { padding: .75rem 1rem; border-bottom: 1px solid #e5e5e5; display:flex; gap:1rem; align-items: center; flex-wrap: wrap; }
  header .group { display:flex; gap:.5rem; align-items: center; flex-wrap: wrap; }
  label { font-size:.9rem; color:#444; }
  input[type="text"], select, button { font-size: .95rem; padding: .4rem .6rem; }
  select { min-width: 220px; }
  #map { height: calc(100vh - 88px); }
  .legend { position: absolute; right: 10px; bottom: 10px; background: #fff; padding: .5rem .75rem; border: 1px solid #ddd; border-radius: .5rem; font-size:.85rem;}
  .legend div { margin:.15rem 0; }
  .swatch { display:inline-block; width:10px; height:10px; margin-right:.35rem; border-radius:10px; vertical-align: middle; }
  .btn { background: #0d6efd; color:#fff; border:0; border-radius:.35rem; cursor:pointer; }
  .btn:disabled { opacity:.5; cursor:default; }
  .btn-outline { background:#fff; color:#0d6efd; border:1px solid #0d6efd; }
  .btn-gray { background:#f4f4f5; color:#111; border:1px solid #e4e4e7; }
  .pill { padding:.2rem .5rem; border:1px solid #e4e4e7; border-radius:999px; background:#fff; cursor:pointer; }
  .pill.active { background:#0d6efd; color:#fff; border-color:#0d6efd; }
</style>
</head>
<body>
<header>
  <div class="group">
    <strong>Apex Map</strong>
    <label>Radius:</label>
    <button class="pill" data-radius="5">5 mi</button>
    <button class="pill" data-radius="10">10 mi</button>
    <button class="pill" data-radius="15">15 mi</button>
    <button class="pill" data-radius="20">20 mi</button>
    <button class="pill" data-radius="0" title="Clear radius filter">None</button>
  </div>

  <div class="group">
    <label>Search WELL/JOBNUM:</label>
    <input id="searchBox" type="text" placeholder="Type part of well or job…" />
    <button id="searchClear" class="btn btn-outline">Clear</button>
  </div>

  <div class="group">
    <label>Operators:</label>
    <select id="operatorSelect" multiple size="1" title="Choose operators (Ctrl/Cmd+Click for multiple)"></select>
    <button id="opAll" class="btn btn-outline" title="Select all operators">All</button>
    <button id="opNone" class="btn btn-outline" title="Clear operators">None</button>
  </div>

  <div class="group">
    <button id="exportRigs" class="btn btn-gray">Export Rigs</button>
    <button id="exportRuns" class="btn btn-gray">Export Visible Runs CSV</button>
  </div>

  <div class="group">
    <label>Rig name</label><input id="rigName" type="text" size="12" placeholder="e.g. Apex 123" />
    <label>Lat</label><input id="rigLat" type="text" size="8" />
    <label>Lon</label><input id="rigLon" type="text" size="9" />
    <button id="addRig" class="btn">Add Rig</button>
    <button id="clearRigs" class="btn btn-outline">Clear Rigs</button>
    <button id="showAll" class="btn btn-outline" title="Reset filters and show everything">Show All</button>
  </div>
</header>

<div id="map"></div>

<div class="legend">
  <div><span class="swatch" style="background:#20c997"></span>Normal run</div>
  <div><span class="swatch" style="background:#fd7e14"></span>MWD failure</div>
  <div><span class="swatch" style="background:#dc3545"></span>Motor failure</div>
  <div><span class="swatch" style="background:#0d6efd"></span>Apex rig</div>
</div>

<!-- =========  INLINE CSV DATA  ========= -->
<script type="text/csv" id="apexRigsCsv">
RIG,LAT,LONG
Precision 614,31.8030862,-93.4990316
Independence 336,31.6898864,-93.9877853
Independence 334,32.3357351,-93.7547091
Precision 576,31.8021106,-93.4987048
Independence 301,32.3512632,-93.2446695
Independence 335,31.9030738,-93.5843539
Independence 304,31.9022949,-93.5842684
Independence 322,32.4112973,-93.5703799
Cactus 158,32.1480576,-93.3969841
</script>
<script type="text/csv" id="runsCsv">
OPERATOR,RIG,JOBNUM,WELL,STATE,COUNTY,DATEIN,DATEOUT,TOTAL DRILL,AVG ROP,LAT,LONG,MWD_FAILURE,MOTOR_FAILURE,NEAREST_RIG,NEAREST_RIG_MI
"MATRIX PETROLEUM, LLC",Ensign T120,TX-DMP-220065,NO. 1H - TRINITY UNIT - Wellbore 1,Texas,Lavaca,2022-08-28,2022-08-31,3630.0,114.934,29.55009,-97.06944,1,0,Independence 336,235.42020943523895
Modern Exploration Inc.,Ensign T120,TX-FP-210046,2H - Grover - Wellbore 1,Texas,Lavaca,2021-10-31,2021-11-03,4576.0,120.158,29.57845,-97.05994,1,0,Independence 336,233.73260340155
Modern Exploration Inc.,Ensign T120,TX-FP-210046,2H - Grover - Wellbore 1,Texas,Lavaca,2021-11-03,2021-11-05,0.0,0.0,29.57845,-97.05994,1,1,Independence 336,233.73260340155
Modern Exploration Inc.,Ensign T120,TX-FP-210046,2H - Grover - Wellbore 1,Texas,Lavaca,2021-11-05,2021-11-07,2082.0,81.117,29.57845,-97.05994,0,0,Independence 336,233.73260340155
"Riley Permian Operating Co., LLC",Ensign T120,TX-FP-220064,1H - BAMSCH-TEINERT - ST01,Texas,Lee,2022-07-19,2022-07-22,3509.0,138.97,30.10857,-96.91273,0,0,Independence 336,204.94709121112643
"Riley Permian Operating Co., LLC",Ensign T120,TX-FP-220064,1H - BAMSCH-TEINERT - ST01,Texas,Lee,2022-07-25,2022-07-26,0.0,0.0,30.10857,-96.91273,0,0,Independence 336,204.94709121112643
"Riley Permian Operating Co., LLC",Ensign T120,TX-FP-220064,1H - BAMSCH-TEINERT - ST01,Texas,Lee,2022-07-31,2022-08-06,2054.0,117.371,30.10857,-96.91273,0,0,Independence 336,204.94709121112643
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,,003-ALT - OH,,,,,4008.0,159.258,32.12251,-93.77341,0,0,Independence 334,14.772942006906273
Sponte Resources,Basin 101,TX-FP-230009,SARGE 3HH - Wellbore 1,Texas,Panola,2023-03-15,2023-03-15,18.0,54.0,32.30304,-94.46716,1,0,Independence 334,41.66088942421422
Sponte Resources,Basin 101,TX-FP-230009,SARGE 3HH - Wellbore 1,Texas,Panola,2023-03-15,2023-03-16,300.0,81.818,32.30304,-94.46716,1,0,Independence 334,41.66088942421422
Sponte Resources,Basin 101,TX-FP-230009,SARGE 3HH - Wellbore 1,Texas,Panola,2023-03-16,2023-03-21,8488.0,111.684,32.30304,-94.46716,0,0,Independence 334,41.66088942421422
Sponte Resources,Basin 101,TX-FP-230010,RODEO 4HH - Wellbore 1,Texas,Panola,2023-03-26,2023-03-31,8758.0,116.903,32.30306,-94.46721,0,0,Independence 334,41.663725102228824
Sponte Resources,Basin 101,TX-FP-220116,CINCO 1HH - Wellbore 1,Texas,Panola,2023-01-24,2023-01-30,9655.0,93.814,32.30449,-94.46193,0,0,Independence 334,41.350284911751366
Sponte Resources,Basin 101,TX-FP-220117,MR. OTIS 2HH - Wellbore 1,Texas,Panola,2023-02-05,2023-02-06,2005.0,103.262,32.30449,-94.46204,1,0,Independence 334,41.356698915977944
Sponte Resources,Basin 101,TX-FP-220117,MR. OTIS 2HH - Wellbore 1,Texas,Panola,2023-02-06,2023-02-11,6132.0,68.196,32.30449,-94.46204,0,1,Independence 334,41.356698915977944
Sponte Resources,Basin 101,TX-FP-220026,7HH - BLUE-TATUM UNIT - Wellbore 1,Texas,Panola,2022-04-17,2022-04-19,2452.0,107.387,32.3132,-94.4891,0,0,Independence 334,42.90651288695558
Sponte Resources,Basin 101,TX-FP-220027,8HH - BLUE-TATUM UNIT - Wellbore 1,Texas,Panola,2022-05-09,2022-05-10,439.0,49.234,32.31329,-94.48908,0,0,Independence 334,42.90509943256877
Sponte Resources,Nabors X33,TX-FP-210022,Wagstaff-Beckville 2HH - OH,Texas,Panola,2021-08-29,2021-09-03,8273.0,119.179,32.33006,-94.4734,0,0,Independence 334,41.95951886842131
Sponte Resources,Nabors X33,TX-FP-210024,Wagstaff-Beckville 4HH - OH,Texas,Panola,2021-10-02,2021-10-04,2558.0,81.638,32.33006,-94.4736,0,1,Independence 334,41.97119445737377
Sponte Resources,Basin 103,TX-DMP-240042,2H - BARTLETT-THOMPSON PAD - OH,Texas,Harrison,2024-09-16,2024-09-23,9944.0,111.003,32.39847,-94.46013,0,0,Independence 334,41.39497037932998
Sponte Resources,Basin 103,TX-DMP-240041,1H - BARTLETT-THOMPSON PAD - OH,Texas,Harrison,2024-09-27,2024-10-01,5002.0,99.213,32.39855,-94.46016,0,0,Independence 334,41.39727251571203
Sponte Resources,Basin 103,TX-DMP-240041,1H - BARTLETT-THOMPSON PAD - OH,Texas,Harrison,2024-10-01,2024-10-08,6388.0,67.479,32.39855,-94.46016,0,0,Independence 334,41.39727251571203
Sponte Resources,Basin 101,TX-DMP-250020,GEORGE-LANDRY A 1H - OH,Texas,Harrison,2025-07-04,2025-07-08,9859.0,177.64,32.40865,-94.44716,0,0,Independence 334,40.721061575480554
Sponte Resources,Basin 101,TX-DMP-250021,GEORGE-LANDRY B 2H - OH,Texas,Harrison,2025-07-12,2025-07-16,6594.0,119.529,32.40869,-94.44723,0,1,Independence 334,40.725448159209535
Sponte Resources,Basin 101,TX-DMP-250021,GEORGE-LANDRY B 2H - OH,Texas,Harrison,2025-07-16,2025-07-21,3427.0,79.852,32.40869,-94.44723,0,0,Independence 334,40.725448159209535
Sponte Resources,Basin 101,TX-DMP-250022,GEORGE-LANDRY C 3H - OH,Texas,Harrison,2025-07-25,2025-07-30,9064.0,141.257,32.40872,-94.4473,0,0,Independence 334,40.729751533698476
Sponte Resources,Basin 101,TX-DMP-250023,BARTLETT-LANDRY 4H - OH,Texas,Harrison,2025-08-03,2025-08-11,10011.0,103.562,32.40876,-94.44737,0,0,Independence 334,40.734138322288416
Sponte Resources,Basin 101,TX-FP-230027,BRUNE-HARRIS 4H - Wellbore 1,Texas,Harrison,2023-05-15,2023-05-20,8759.0,108.136,32.41757,-94.42125,0,0,Independence 334,39.30315807446045
Sponte Resources,Basin 101,TX-FP-230027,BRUNE-HARRIS 4H - Wellbore 1,Texas,Harrison,2023-05-20,2023-05-23,1023.0,50.938,32.41757,-94.42125,0,0,Independence 334,39.30315807446045
Sponte Resources,Basin 101,TX-FP-230026,BRUNE-HARRIS 3H - Wellbore 1,Texas,Harrison,2023-05-03,2023-05-04,333.0,86.87,32.41763,-94.42129,1,0,Independence 334,39.30605167459273
Sponte Resources,Basin 101,TX-FP-230026,BRUNE-HARRIS 3H - Wellbore 1,Texas,Harrison,2023-05-04,2023-05-10,9465.0,94.257,32.41763,-94.42129,0,0,Independence 334,39.30605167459273
Sponte Resources,Basin 101,TX-FP-220039,BRUNE-HARRIS 1H - BRUNE-HARRIS PAD - Wellbore 1,Texas,Harrison,2022-06-24,2022-06-30,4151.0,52.6,32.41861,-94.40916,0,0,Independence 334,38.61552323182076
Sponte Resources,Basin 101,TX-FP-220039,BRUNE-HARRIS 1H - BRUNE-HARRIS PAD - Wellbore 1,Texas,Harrison,2025-11-05,2025-11-05,737.0,52.024,32.41861,-94.40916,0,0,Independence 334,38.61552323182076
TRINITY OPERATING,Cactus 150,TX-DMP-240027,MATTERHORN A UNIT No. 2H - OH,Texas,Harrison,2024-05-14,2024-05-20,7853.0,75.813,32.56202,-94.09798,0,0,Independence 334,25.39752646281603
TRINITY OPERATING,Cactus 150,TX-DMP-240027,MATTERHORN A UNIT No. 2H - OH,Texas,Harrison,2024-05-20,2024-05-26,5149.0,71.021,32.56202,-94.09798,0,0,Independence 334,25.39752646281603
SOUTHWESTERN ENERGY,Patterson 591,LA-DP-220031,LABO 23&26-9-13 HC 2 - LABO 23&26-9-13 HC PAD - Wellbore 1,Louisiana,Sabine,2022-06-22,2022-06-26,2088.0,40.283,31.75735,-93.66974,0,0,Precision 576,10.511004896479553
"AZUL RESOURCES, LLC",Basin 101,LA-DMP-220082,2H - WALKER UNIT - Wellbore 1,Louisiana,Natchitoches,2022-10-31,2022-11-04,2392.0,60.05,31.86064,-93.4288,0,0,Precision 614,5.728005639229897
"AZUL RESOURCES, LLC",Basin 101,LA-DMP-220082,2H - WALKER UNIT - Wellbore 1,Louisiana,Natchitoches,2022-11-05,2022-11-06,49.0,39.2,31.86064,-93.4288,1,0,Precision 614,5.728005639229897
"AZUL RESOURCES, LLC",Basin 101,LA-DMP-220081,1H - WALKER UNIT - Wellbore 1,Louisiana,Natchitoches,2022-11-29,2022-12-03,2407.0,40.117,31.86064,-93.42886,0,0,Precision 614,5.72547113695806
SOUTHWESTERN ENERGY,SDC 503,LA-DP-220072,BRUSHY G 33&4-11-12HC No.1 - BRUSHY G 33&4-11-12HC Pad - Wellbore 1,Louisiana,De Soto,2022-11-28,2022-12-06,11458.0,96.896,31.90473,-93.60599,0,0,Independence 335,1.2742329742401597
SOUTHWESTERN ENERGY,SDC 503,LA-DP-220083,BRUSHY G 33&4-11-12HC No.2 - BRUSHY G 33&4-11-12HC Pad - Wellbore 1,Louisiana,De Soto,2022-12-11,2022-12-16,7398.04,91.996,31.90473,-93.60589,1,0,Independence 335,1.2683911973512212
SOUTHWESTERN ENERGY,SDC 503,La-DP-220054,HA RA SUWW; WM 27&22&15-11-10HC No. 1-ALT - WM Pads - Wellbore 1,Louisiana,Natchitoches,2022-06-29,2022-07-06,8775.0,77.541,31.91475,-93.38373,0,0,Precision 614,10.262028247995962
SOUTHWESTERN ENERGY,SDC 503,LA-DP-220053,HA RA SUX; WM 22&15-11-10HC No. 1-ALT - WM Pads - ST01,Louisiana,Natchitoches,2022-07-15,2022-07-17,837.0,77.86,31.91475,-93.38363,0,0,Precision 614,10.265898642843206
SOUTHWESTERN ENERGY,SDC 503,LA-DP-220053,HA RA SUX; WM 22&15-11-10HC No. 1-ALT - WM Pads - ST01,Louisiana,Natchitoches,2022-07-20,2022-07-23,3598.0,109.863,31.91475,-93.38363,1,0,Precision 614,10.265898642843206
SOUTHWESTERN ENERGY,SDC 503,LA-DP-220053,HA RA SUX; WM 22&15-11-10HC No. 1-ALT - WM Pads - ST01,Louisiana,Natchitoches,2022-07-23,2022-07-25,482.0,74.154,31.91475,-93.38363,0,0,Precision 614,10.265898642843206
SOUTHWESTERN ENERGY,SDC 503,LA-DMP-240005,CLECO 25-36 11-11 HC 3 - OH,Louisiana,De Soto,2024-03-09,2024-03-16,7412.0,62.329,31.91662,-93.4518,0,0,Independence 335,7.830696991806141
SOUTHWESTERN ENERGY,SDC 503,LA-DMP-240004,CLECO 25-1 11-11 HC 2 - ST01,Louisiana,De Soto,2024-03-28,2024-03-31,1942.0,44.053,31.91662,-93.4519,0,0,Independence 335,7.824873861834969
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-230024,1-ALT - HA RA SUD; PETRO-HUNT 13-12HC - ST01,Louisiana,De Soto,2023-04-08,2023-04-08,7107.0,87.024,31.93315,-93.75911,0,0,Independence 335,10.457439649317775
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-230024,1-ALT - HA RA SUD; PETRO-HUNT 13-12HC - Wellbore 1,Louisiana,De Soto,2023-04-08,2023-04-14,7107.0,87.024,31.93315,-93.75911,0,0,Independence 335,10.457439649317775
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-230024,1-ALT - HA RA SUD; PETRO-HUNT 13-12HC - ST02,Louisiana,De Soto,2023-04-08,2023-04-08,7107.0,87.024,31.93315,-93.75911,0,0,Independence 335,10.457439649317775
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-230024,1-ALT - HA RA SUD; PETRO-HUNT 13-12HC - ST01,Louisiana,De Soto,2023-04-14,2023-04-17,2484.0,87.158,31.93315,-93.75911,0,0,Independence 335,10.457439649317775
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-230024,1-ALT - HA RA SUD; PETRO-HUNT 13-12HC - Wellbore 1,Louisiana,De Soto,2023-04-14,2023-04-14,0.0,0.0,31.93315,-93.75911,0,0,Independence 335,10.457439649317775
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-230024,1-ALT - HA RA SUD; PETRO-HUNT 13-12HC - ST02,Louisiana,De Soto,2023-04-14,2023-04-17,2484.0,87.158,31.93315,-93.75911,0,0,Independence 335,10.457439649317775
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-230024,1-ALT - HA RA SUD; PETRO-HUNT 13-12HC - ST01,Louisiana,De Soto,2023-04-17,2023-04-22,7446.0,98.081,31.93315,-93.75911,0,0,Independence 335,10.457439649317775
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-230024,1-ALT - HA RA SUD; PETRO-HUNT 13-12HC - ST02,Louisiana,De Soto,2023-04-17,2023-04-22,7446.0,98.081,31.93315,-93.75911,0,0,Independence 335,10.457439649317775
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-230025,2-ALT - HA RA SUD; PETRO-HUNT 13-12HC - Wellbore 1,Louisiana,De Soto,2023-05-02,2023-05-05,4545.0,154.504,31.93319,-93.75911,0,1,Independence 335,10.457987016123944
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-230025,2-ALT - HA RA SUD; PETRO-HUNT 13-12HC - Wellbore 1,Louisiana,De Soto,2023-05-05,2023-05-08,2172.0,108.149,31.93319,-93.75911,0,0,Independence 335,10.457987016123944
SOUTHWESTERN ENERGY,SDC 503,LA-DMP-230064,RKN G 20-17-8 11-12 HC1 - OH,Louisiana,De Soto,2023-12-25,2023-12-27,126.0,20.712,31.93389,-93.60774,0,0,Independence 335,2.5326923768259295
SOUTHWESTERN ENERGY,SDC 503,LA-DMP-230052,SWN 11&14 11-9 HC 1 - OH,Louisiana,Red River,2023-11-01,2023-11-03,457.0,29.484,31.95534,-93.27339,0,0,Cactus 158,15.155508163049168
SOUTHWESTERN ENERGY,SDC 503,LA-DMP-230052,SWN 11&14 11-9 HC 1 - OH,Louisiana,Red River,2023-11-03,2023-11-08,3173.0,40.249,31.95534,-93.27339,0,0,Cactus 158,15.155508163049168
SOUTHWESTERN ENERGY,SDC 503,LA-DMP-230052,SWN 11&14 11-9 HC 1 - OH,Louisiana,Red River,2023-11-08,2023-11-18,5760.0,34.032,31.95534,-93.27339,1,0,Cactus 158,15.155508163049168
SOUTHWESTERN ENERGY,SDC 503,LA-DMP-230053,SWN 10&15 11-9 HC 1-ALT - OH,Louisiana,Red River,2023-09-12,2023-09-15,1412.0,64.426,31.95542,-93.27339,0,0,Cactus 158,15.150650486998966
SOUTHWESTERN ENERGY,SDC 503,LA-DMP-230053,SWN 10&15 11-9 HC 1-ALT - OH,Louisiana,Red River,2023-09-16,2023-09-21,3942.0,47.685,31.95542,-93.27339,0,0,Cactus 158,15.150650486998966
SOUTHWESTERN ENERGY,SDC 503,LA-DMP-230053,SWN 10&15 11-9 HC 1-ALT - OH,Louisiana,Red River,2023-09-21,2023-09-24,351.0,45.29,31.95542,-93.27339,0,0,Cactus 158,15.150650486998966
Tellurian Inc.,Basin 105,LA-DMP-220019,B 4-ALT - THOMAS RUFFIN 01&36-11-11 HC - Wellbore 1,Louisiana,De Soto,2022-07-12,2022-07-14,17.0,13.6,31.97036,-93.44596,0,0,Independence 335,9.352120177413447
Tellurian Inc.,Basin 105,LA-DMP-210068,3-ALT - NRG 29-12-10 H - Wellbore 1,Louisiana,Red River,2022-01-21,2022-01-25,2848.0,43.872,31.99142,-93.42084,0,0,Cactus 158,10.912387542400594
Tellurian Inc.,Basin 105,LA-DMP-210067,4-ALT - NRG 29-12-10 H - Wellbore 1,Louisiana,Red River,2022-02-10,2022-02-16,2458.0,28.389,31.99142,-93.42093,0,0,Cactus 158,10.913063276379706
SOUTHWESTERN ENERGY,Patterson 591,LA-DP-220093,OLYM 21&16-12-14HC NO. 1 - OLYM PAD - Wellbore 1,Louisiana,De Soto,2022-10-17,2022-10-19,0.0,0.0,32.0064,-93.80469,0,0,Independence 335,14.758481692872204
SOUTHWESTERN ENERGY,Patterson 591,LA-DP-220093,OLYM 21&16-12-14HC NO. 1 - OLYM PAD - Wellbore 1,Louisiana,De Soto,2022-10-23,2022-10-24,20.0,80.0,32.0064,-93.80469,0,0,Independence 335,14.758481692872204
SOUTHWESTERN ENERGY,Patterson 591,LA-DP-220093,OLYM 21&16-12-14HC NO. 1 - OLYM PAD - Wellbore 1,Louisiana,De Soto,2022-10-26,2022-10-29,1194.0,33.555,32.0064,-93.80469,0,0,Independence 335,14.758481692872204
SOUTHWESTERN ENERGY,Patterson 591,LA-DP-220093,OLYM 21&16-12-14HC NO. 1 - OLYM PAD - Wellbore 1,Louisiana,De Soto,2022-11-03,2022-11-09,3938.0,78.109,32.0064,-93.80469,0,0,Independence 335,14.758481692872204
SOUTHWESTERN ENERGY,Patterson 591,LA-DP-220093,OLYM 21&16-12-14HC NO. 1 - OLYM PAD - Wellbore 1,Louisiana,De Soto,2022-11-09,2022-11-13,891.0,95.464,32.0064,-93.80469,0,0,Independence 335,14.758481692872204
SOUTHWESTERN ENERGY,Patterson 591,LA-DP-220092,OLYM 21&16&9-12-14HC NO. 1-ALT - OLYM PAD - Wellbore 1,Louisiana,De Soto,2022-11-17,2022-11-20,1240.0,44.286,32.0064,-93.80479,0,0,Independence 335,14.763612777798961
SOUTHWESTERN ENERGY,SDC 503,LA-DP-220014,"PUGH 11&14&23-12-15 HC No.1-Alt - PUGH 11&2, 11&14&23, 14&23-12-15HC - Wellbore 1",Louisiana,De Soto,2022-04-18,2022-04-25,12245.0,103.845,32.03582,-93.87293,0,0,Independence 335,19.241292734656952
SOUTHWESTERN ENERGY,SDC 503,LA-DP-220015,"PUGH 14&23-12-15 HC No.1-Alt - PUGH 11&2, 11&14&23, 14&23-12-15HC - Wellbore 1",Louisiana,De Soto,2022-05-01,2022-05-07,8431.0,89.612,32.0359,-93.87293,0,0,Independence 335,19.243921682933717
SOUTHWESTERN ENERGY,SDC 503,LA-DMP-220037,5-8-17 12-15HC 1-ALT - OH,Louisiana,De Soto,2023-07-10,2023-07-11,10.0,120.0,32.06329,-93.93373,1,0,Independence 334,21.538377701867688
SOUTHWESTERN ENERGY,SDC 503,LA-DMP-220037,5-8-17 12-15HC 1-ALT - OH,Louisiana,De Soto,2023-07-11,2023-07-18,9812.0,82.627,32.06329,-93.93373,0,0,Independence 334,21.538377701867688
SOUTHWESTERN ENERGY,SDC 503,LA-DMP-230038,5-8 12-15HC 1-ALT - OH,Louisiana,De Soto,2023-06-23,2023-06-24,10.0,40.0,32.06338,-93.93373,0,0,Independence 334,21.53294062553547
SOUTHWESTERN ENERGY,SDC 503,LA-DMP-230038,5-8 12-15HC 1-ALT - OH,Louisiana,De Soto,2023-06-25,2023-07-02,9177.0,76.581,32.06338,-93.93373,0,0,Independence 334,21.53294062553547
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DP-220095,"2-ALT - KERVIN, ETAL 13H - Wellbore 1",Louisiana,Red River,2022-11-05,2022-11-09,4858.0,68.826,32.11952,-93.44809,0,0,Cactus 158,3.5817358068318748
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DP-220096,"3-ALT - KERVIN, ETAL 13H - Wellbore 1",Louisiana,Red River,2022-10-27,2022-10-30,4930.0,96.509,32.11956,-93.4481,0,0,Cactus 158,3.580703227323059
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DP-220099,"4-ALT - KERVIN, ETAL 13H - Wellbore 1",Louisiana,Red River,2022-10-19,2022-10-22,3761.0,111.163,32.1196,-93.44811,0,0,Cactus 158,3.5796725789448884
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-230001,4-ALT - ALBRITTON CATTLE 8H,Louisiana,De Soto,2023-02-04,2023-02-08,4843.0,70.529,32.12182,-93.51679,0,0,Cactus 158,7.240248312718319
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 101,LA-DP-220077,2-ALT - ALBRITTON CATTLE 8H - Wellbore 1,Louisiana,De Soto,2022-09-11,2022-09-14,3511.0,79.047,32.12214,-93.51628,0,0,Cactus 158,7.205825286474435
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 101,LA-DP-220078,3-ALT - ALBRITTON CATTLE 8H - Wellbore 1,Louisiana,De Soto,2022-08-28,2022-09-01,4916.0,84.516,32.12217,-93.51624,0,0,Cactus 158,7.203042297006255
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-240054,003-ALT - ST01,Louisiana,De Soto,2024-11-20,2024-11-25,4008.0,159.258,32.12251,-93.77341,0,0,Independence 334,14.772942006906273
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-240054,003-ALT - ST01,Louisiana,De Soto,2024-11-27,2024-12-02,3950.0,145.399,32.12251,-93.77341,0,0,Independence 334,14.772942006906273
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-240053,002-ALT - OH,Louisiana,De Soto,2024-11-13,2024-11-15,4126.0,126.306,32.12256,-93.77341,0,0,Independence 334,14.7694967847975
SOUTHWESTERN ENERGY,SDC 503,LA-FP-240025,FORT 32-19 14-16HC 1-ALT - OH,Louisiana,De Soto,2024-06-21,2024-07-02,15891.0,109.782,32.15305,-94.03426,0,0,Independence 334,20.644589668933826
SOUTHWESTERN ENERGY,SDC 503,LA-FP-240024,FORT 32-20 14-16HC 1-ALT - OH,Louisiana,De Soto,2024-07-08,2024-07-16,12658.0,98.315,32.15305,-94.03416,0,0,Independence 334,20.639965725319524
SOUTHWESTERN ENERGY,SDC 503,LA-FP-240024,FORT 32-20 14-16HC 1-ALT - OH,Louisiana,De Soto,2024-07-16,2024-07-18,0.0,0.0,32.15305,-94.03416,0,0,Independence 334,20.639965725319524
SOUTHWESTERN ENERGY,SDC 503,LA-FP-240023,FORT 31-19 14-16HC 1-ALT - OH,Louisiana,De Soto,2024-08-04,2024-08-14,16356.0,102.278,32.15305,-94.03436,0,0,Independence 334,20.64921423091412
SOUTHWESTERN ENERGY,SDC 502,LA-DP-220001,No. 1-ALT - HA RA SU95; Gray 32&29-14-16HC Pad - OH,Louisiana,De Soto,2022-05-07,2022-05-08,117.0,66.857,32.15347,-94.02338,1,0,Independence 334,20.127023902669468
SOUTHWESTERN ENERGY,SDC 502,LA-DP-220001,No. 1-ALT - HA RA SU95; Gray 32&29-14-16HC Pad - OH,Louisiana,De Soto,2022-05-08,2022-05-20,11262.0,91.81,32.15347,-94.02338,0,0,Independence 334,20.127023902669468
SOUTHWESTERN ENERGY,SDC 502,LA-DP-220002,No. 2-ALT - HA RA SU95; Gray 32&29-14-16HC Pad - OH,Louisiana,De Soto,2022-04-23,2022-04-29,11449.0,124.333,32.15352,-94.02331,0,0,Independence 334,20.121667998974818
SOUTHWESTERN ENERGY,SDC 502,LA-DP-210077,No. 3-ALT - HA RA SU95; Gray 32&29-14-16HC Pad - OH,Louisiana,De Soto,2022-04-08,2022-04-18,11143.0,78.796,32.15357,-94.02323,0,0,Independence 334,20.11585624237465
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Baisn 103,LA-FP-220034,"4-ALT - HA RA SU73; CTF, LLC 33H (3-ALT & 4-ALT) - Wellbore 1",Louisiana,De Soto,2022-05-19,2022-05-20,611.0,44.169,32.16567,-93.90646,0,0,Independence 334,14.720790144634787
SOUTHWESTERN ENERGY,SDC 503,LA-DP-230020,CRENSH 24&13-14-10HC 2-ALT - CRENSH PAD - OH,Louisiana,Red River,2023-04-16,2023-04-24,8464.0,71.076,32.1784,-93.34662,0,0,Cactus 158,3.6156408461457334
SOUTHWESTERN ENERGY,SDC 503,LA-FP-240046,BTHD 24-13-14 14-10 HC 1 - OH,Louisiana,Red River,2024-11-07,2024-11-09,1856.0,61.355,32.17843,-93.35714,0,0,Cactus 158,3.136077378115445
SOUTHWESTERN ENERGY,SDC 503,LA-FP-240046,BTHD 24-13-14 14-10 HC 1 - OH,Louisiana,Red River,2024-11-12,2024-11-20,8202.0,55.263,32.17843,-93.35714,0,0,Cactus 158,3.136077378115445
SOUTHWESTERN ENERGY,SDC 503,LA-FP-240048,BTHD 23-14 14-10 HC 2 ALT,Louisiana,Red River,2024-10-22,2024-10-28,6853.0,75.585,32.17851,-93.35714,0,0,Cactus 158,3.139778061435263
SOUTHWESTERN ENERGY,SDC 503,LA-FP-240048,BTHD 23-14 14-10 HC 2 ALT,Louisiana,Red River,2024-10-28,2024-11-03,5388.0,51.396,32.17851,-93.35714,0,0,Cactus 158,3.139778061435263
SOUTHWESTERN ENERGY,SDC 503,LA-FP-240047,BTHD 23-14 14-10 HC 1 - OH,Louisiana,Red River,2024-10-03,2024-10-05,0.0,0.0,32.17859,-93.35714,0,0,Cactus 158,3.1434841075677493
SOUTHWESTERN ENERGY,SDC 503,LA-FP-240047,BTHD 23-14 14-10 HC 1 - OH,Louisiana,Red River,2024-10-06,2024-10-13,9061.0,66.707,32.17859,-93.35714,0,0,Cactus 158,3.1434841075677493
SOUTHWESTERN ENERGY,SDC 503,LA-FP-240047,BTHD 23-14 14-10 HC 1 - OH,Louisiana,Red River,2024-10-13,2024-10-18,3255.0,48.282,32.17859,-93.35714,0,0,Cactus 158,3.1434841075677493
SOUTHWESTERN ENERGY,SDC 502,LA-DP-220045,EDWL 18&7&6-14-14 HC 1 ALT - EDWL PAD - Wellbore 1,Louisiana,De Soto,2022-08-20,2022-08-23,2444.0,73.688,32.20642,-93.84176,0,0,Independence 334,10.280761542011826
SOUTHWESTERN ENERGY,SDC 502,LA-DP-220045,EDWL 18&7&6-14-14 HC 1 ALT - EDWL PAD - Wellbore 1,Louisiana,De Soto,2022-08-24,2022-08-30,7851.0,96.331,32.20642,-93.84176,0,0,Independence 334,10.280761542011826
SOUTHWESTERN ENERGY,SDC 502,LA-DP-220045,EDWL 18&7&6-14-14 HC 1 ALT - EDWL PAD - Wellbore 1,Louisiana,De Soto,2022-08-30,2022-09-03,1065.0,67.619,32.20642,-93.84176,0,0,Independence 334,10.280761542011826
SOUTHWESTERN ENERGY,SDC 502,LA-DP-220045,EDWL 18&7&6-14-14 HC 1 ALT - EDWL PAD - Wellbore 1,Louisiana,De Soto,2022-09-04,2022-09-04,0.0,0.0,32.20642,-93.84176,0,0,Independence 334,10.280761542011826
SOUTHWESTERN ENERGY,SDC 502,LA-DP-220044,EDWL 18&19&30-14-14HC NO. 3 - EDWL PAD - Wellbore 1,Louisiana,De Soto,2022-09-25,2022-09-30,7664.0,99.125,32.20642,-93.84186,0,0,Independence 334,10.283652679563286
SOUTHWESTERN ENERGY,SDC 502,LA-DP-220044,EDWL 18&19&30-14-14HC NO. 3 - EDWL PAD - Wellbore 1,Louisiana,De Soto,2022-09-30,2022-10-04,2167.0,47.89,32.20642,-93.84186,0,0,Independence 334,10.283652679563286
SOUTHWESTERN ENERGY,SDC 502,LA-DP-220044,EDWL 18&19&30-14-14HC NO. 3 - EDWL PAD - Wellbore 1,Louisiana,De Soto,2022-10-06,2022-10-15,4238.0,46.872,32.20642,-93.84186,0,0,Independence 334,10.283652679563286
SOUTHWESTERN ENERGY,SDC 502,LA-DP-220046,EDWL 18&7&6-14-14HC NO. 2-ALT - EDWL PAD - Wellbore 1,Louisiana,De Soto,2022-07-19,2022-07-21,1202.0,75.125,32.20643,-93.84166,0,0,Independence 334,10.277272132314161
SOUTHWESTERN ENERGY,SDC 502,LA-DP-220046,EDWL 18&7&6-14-14HC NO. 2-ALT - EDWL PAD - Wellbore 1,Louisiana,De Soto,2022-07-27,2022-07-31,3061.0,78.994,32.20643,-93.84166,0,0,Independence 334,10.277272132314161
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-FP-210045,4-ALT - SNYDER 31H - Wellbore 1,Louisiana,Bossier,2021-11-10,2021-11-12,771.0,73.429,32.33633,-93.54327,0,0,Independence 322,5.4159438040498316
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-FP-210044,3-ALT - SNYDER 31H - Wellbore 1,Louisiana,Bossier,2021-11-18,2021-11-21,5084.0,93.284,32.33633,-93.54334,0,1,Independence 322,5.414752052097037
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Nabors X17,LA-DMP-250014,2-ALT - WIGGINS 27H - OH,Louisiana,Bossier,2025-04-18,2025-04-20,4257.0,154.8,32.42351,-93.5793,0,0,Independence 322,0.991319628125708
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Nabors X17,LA-DMP-250018,NO. 1 - OH,Louisiana,Webster,2025-05-08,2025-05-11,3615.0,96.186,32.42411,-93.40402,0,0,Independence 322,9.743417337985232
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Nabors X17,LA-DMP-250018,NO. 1 - OH,Louisiana,Webster,2025-05-11,2025-05-15,4188.0,95.182,32.42411,-93.40402,0,0,Independence 322,9.743417337985232
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-220111,2 - McGUIRE 12-1HC PAD - OH,Louisiana,Bossier,2022-12-11,2022-12-16,7425.0,80.488,32.46608,-93.55322,0,0,Independence 322,3.9151548230305595
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-220111,2 - McGUIRE 12-1HC PAD - OH,Louisiana,Bossier,2022-12-16,2022-12-20,1914.0,37.901,32.46608,-93.55322,0,1,Independence 322,3.9151548230305595
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-220102,1 - McGUIRE 12-1HC PAD - OH,Louisiana,Bossier,2022-12-28,2023-01-04,10060.0,83.717,32.46608,-93.55329,0,0,Independence 322,3.9141135658490205
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-FP-210071,NO. 3-ALT - HA RA SU71; CHANDLER 6-7H PAD - Wellbore 1,Louisiana,Bossier,2022-03-21,2022-03-24,4490.0,68.812,32.50099,-93.53214,0,0,Independence 322,6.585996225404076
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-FP-210070,NO. 2-ALT - HA RA SU71; CHANDLER 6-7H PAD - Wellbore 1,Louisiana,Bossier,2022-03-05,2022-03-08,2290.0,63.318,32.50103,-93.53214,0,0,Independence 322,6.5885966967751495
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DP-210069,NO. 1-ALT - HA RA SU71; CHANDLER 6-7H PAD - ST01,Louisiana,Bossier,2022-02-16,2022-02-19,727.0,19.344,32.50107,-93.53214,0,0,Independence 322,6.591197301018702
"ENSIGHT IV ENERGY MANAGEMENT, LLC",Basin 103,LA-DMP-230013,1 - CHANDLER 31-30H - ST01,Louisiana,Bossier,2023-03-04,2023-03-10,9883.0,112.095,32.50123,-93.53214,0,0,Independence 322,6.601601043576992
TRINITY OPERATING,Cactus 150,LA-FP-240033,ANTHONY 31-30-19HC 2-ALT - OH,Louisiana,Caddo,2024-07-16,2024-07-21,7478.0,105.324,32.58474,-93.93487,0,0,Independence 334,20.15721589170452
TRINITY OPERATING,Cactus 150,LA-FP-240033,ANTHONY 31-30-19HC 2-ALT - OH,Louisiana,Caddo,2024-07-21,2024-07-24,2794.0,70.585,32.58474,-93.93487,1,0,Independence 334,20.15721589170452
</script>
<!-- ==================================== -->

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// ---- Config ----
const APEX_ICON_URL = 'img/apex-rig.svg';

// ---- Map setup ----
const map = L.map('map').setView([32.10, -94.00], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:18, attribution:'© OpenStreetMap contributors'}).addTo(map);

const apexRigsLayer = L.layerGroup().addTo(map);
const userRigsLayer = L.layerGroup().addTo(map);
const runsLayer     = L.layerGroup().addTo(map);
let radiusCircle = null;

// ---- State ----
let ALL_RUNS = [];
let APEX_RIGS = [];
let FILTER = { operators:new Set(), text:'', radius:{ center:null, miles:0 } };

// ---- Utils ----
const milesToMeters = mi => mi * 1609.344;
function toNumber(x){ const v = +x; return Number.isFinite(v) ? v : null; }
function haversineMi(lat1, lon1, lat2, lon2){
  const R = 3958.7613, toRad = d=>d*Math.PI/180;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function downloadCsv(filename, rows){
  const csv = d3.csvFormat(rows);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  URL.revokeObjectURL(a.href);
}

// ---- Icons ----
const apexIcon = L.icon({ iconUrl: APEX_ICON_URL, iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-24] });

// ---- Data normalization ----
function normalizeRigs(csv){
  const rows = d3.csvParse(csv);
  const out = [], seen = new Set();
  rows.forEach(r=>{
    const name = (r.RIG || r['Rig Name/Number'] || '').trim();
    const lat  = toNumber(r.LAT || r['Rig Latitude (WGS84)']);
    const lon  = toNumber(r.LONG || r['Rig Longitude (WGS84)']);
    if(!name || !Number.isFinite(lat) || !Number.isFinite(lon)) return;
    if(seen.has(name)) return; seen.add(name);
    out.push({RIG:name, LAT:lat, LONG:lon});
  });
  return out;
}

function normalizeRuns(csv){
  const rows = d3.csvParse(csv);
  function pick(o, keys){ for(const k of keys){ if(o[k]!==undefined) return o[k]; } }
  const out = rows.map(r=>({
    OPERATOR:(pick(r,['OPERATOR'])||'').trim(),
    RIG:(pick(r,['RIG'])||'').trim(),
    JOBNUM:(pick(r,['JOBNUM'])||'').trim(),
    WELL:(pick(r,['WELL'])||'').trim(),
    STATE:(pick(r,['STATE'])||'').trim(),
    COUNTY:(pick(r,['COUNTY'])||'').trim(),
    DATEIN:(pick(r,['DATEIN'])||'').trim(),
    DATEOUT:(pick(r,['DATEOUT'])||'').trim(),
    TOTAL_DRILL: toNumber(pick(r,['TOTAL DRILL','TOTAL_DRILL'])) ?? 0,
    AVG_ROP:     toNumber(pick(r,['AVG ROP','AVG_ROP'])) ?? null,
    LAT:  toNumber(pick(r,['LAT'])),
    LONG: toNumber(pick(r,['LONG'])),
    MWD_FAILURE:   +(pick(r,['MWD_FAILURE','MWD FAILURE'])||0),
    MOTOR_FAILURE: +(pick(r,['MOTOR_FAILURE','MOTOR FAILURE'])||0),
    NEAREST_RIG: pick(r,['NEAREST_RIG']),
    NEAREST_RIG_MI: toNumber(pick(r,['NEAREST_RIG_MI']))
  })).filter(d => Number.isFinite(d.LAT) && Number.isFinite(d.LONG));

  // If NEAREST_RIG not present, compute on the fly vs APEX_RIGS
  if(out.length && APEX_RIGS.length && !out.some(d => d.NEAREST_RIG_MI!=null)){
    out.forEach(d=>{
      let best = {name:null, dist:1e9};
      for(const r of APEX_RIGS){
        const dist = haversineMi(d.LAT,d.LONG,r.LAT,r.LONG);
        if(dist < best.dist) best = {name:r.RIG, dist};
      }
      d.NEAREST_RIG = best.name; d.NEAREST_RIG_MI = best.dist;
    });
  }
  return out;
}

// ---- Rendering ----
function drawApexRigs(){
  apexRigsLayer.clearLayers();
  APEX_RIGS.forEach(r=>{
    L.marker([r.LAT, r.LONG], {icon:apexIcon, title:r.RIG})
      .bindPopup(`<b>Apex Rig:</b> ${r.RIG}<br>(${r.LAT.toFixed(5)}, ${r.LONG.toFixed(5)})`)
      .addTo(apexRigsLayer);
  });
}
function colorForRun(d){
  if(+d.MOTOR_FAILURE) return '#dc3545';
  if(+d.MWD_FAILURE)   return '#fd7e14';
  return '#20c997';
}
function drawRuns(){
  runsLayer.clearLayers();

  let data = ALL_RUNS.slice();
  if(FILTER.operators.size) {
    data = data.filter(d => FILTER.operators.has(d.OPERATOR));
  }
  const q = (FILTER.text||'').toLowerCase();
  if(q){
    data = data.filter(d => (d.WELL||'').toLowerCase().includes(q) || (d.JOBNUM||'').toLowerCase().includes(q));
  }
  if(FILTER.radius.center && FILTER.radius.miles>0){
    const {lat,lng} = FILTER.radius.center;
    data = data.filter(d => haversineMi(lat,lng,d.LAT,d.LONG) <= FILTER.radius.miles);
  }

  data.forEach(d=>{
    L.circleMarker([d.LAT, d.LONG], { radius:5, color:colorForRun(d), weight:1, fillOpacity:.7 })
      .bindPopup(`
        <b>${d.OPERATOR}</b><br>${d.WELL || '(no well name)'}<br>
        Rig: ${d.RIG || '-'} | AVG ROP: ${d.AVG_ROP ?? '-'}<br>
        ${d.DATEIN || ''} → ${d.DATEOUT || ''}<br>
        Nearest Apex: ${d.NEAREST_RIG || '-'} (${Number.isFinite(+d.NEAREST_RIG_MI) ? (+d.NEAREST_RIG_MI).toFixed(1)+' mi' : '-'})
      `)
      .addTo(runsLayer);
  });

  return data;
}
function fitToAll(){
  const g = L.featureGroup([apexRigsLayer, runsLayer]);
  try { map.fitBounds(g.getBounds().pad(0.1)); } catch(e){}
}

// ---- UI wiring ----
const searchBox    = document.getElementById('searchBox');
const searchClear  = document.getElementById('searchClear');
const opSelect     = document.getElementById('operatorSelect');
const opAll        = document.getElementById('opAll');
const opNone       = document.getElementById('opNone');
const exportRigs   = document.getElementById('exportRigs');
const exportRuns   = document.getElementById('exportRuns');
const addRigBtn    = document.getElementById('addRig');
const clearRigsBtn = document.getElementById('clearRigs');
const showAllBtn   = document.getElementById('showAll');

function populateOperatorSelect(){
  const uniq = [...new Set(ALL_RUNS.map(d=>d.OPERATOR).filter(Boolean))].sort();
  opSelect.innerHTML = '';
  uniq.forEach(op => {
    const opt = document.createElement('option');
    opt.value = op; opt.textContent = op;
    opSelect.appendChild(opt);
  });
}
function readSelectedOperators(){
  const chosen = new Set();
  for(const opt of opSelect.selectedOptions) chosen.add(opt.value);
  FILTER.operators = chosen;
  drawRuns();
}

opSelect.addEventListener('change', readSelectedOperators);
opAll.addEventListener('click',  ()=>{ for(const opt of opSelect.options) opt.selected = true;  readSelectedOperators(); });
opNone.addEventListener('click', ()=>{ for(const opt of opSelect.options) opt.selected = false; readSelectedOperators(); });

searchBox.addEventListener('input', ()=>{ FILTER.text = searchBox.value || ''; drawRuns(); });
searchClear.addEventListener('click', ()=>{ searchBox.value = ''; FILTER.text = ''; drawRuns(); });

// Radius pills
document.querySelectorAll('[data-radius]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const mi = +btn.getAttribute('data-radius');
    document.querySelectorAll('[data-radius]').forEach(b => b.classList.toggle('active', b===btn));
    if(mi===0){
      FILTER.radius = { center:null, miles:0 };
      if(radiusCircle){ map.removeLayer(radiusCircle); radiusCircle = null; }
      drawRuns();
      return;
    }
    alert(`Click the map to set the ${mi} mile radius center.`);
    FILTER.radius.miles = mi;
  });
});

// Map click: set radius center OR prefill Add-Rig
map.on('click', e=>{
  if(FILTER.radius.miles>0){
    FILTER.radius.center = e.latlng;
    if(radiusCircle) map.removeLayer(radiusCircle);
    radiusCircle = L.circle(e.latlng, { radius:milesToMeters(FILTER.radius.miles), color:'#0d6efd' }).addTo(map);
    drawRuns();
  }
  document.getElementById('rigLat').value = e.latlng.lat.toFixed(6);
  document.getElementById('rigLon').value = e.latlng.lng.toFixed(6);
});

// Add Rig / Clear Rigs / Show All
addRigBtn.addEventListener('click', ()=>{
  const name = (document.getElementById('rigName').value || '').trim() || 'User Rig';
  const lat  = toNumber(document.getElementById('rigLat').value);
  const lon  = toNumber(document.getElementById('rigLon').value);
  if(!Number.isFinite(lat) || !Number.isFinite(lon)){ alert('Enter valid Lat/Lon'); return; }
  L.marker([lat, lon], { title:name })
    .bindPopup(`<b>${name}</b><br>(${lat.toFixed(5)}, ${lon.toFixed(5)})`)
    .addTo(userRigsLayer);
});
clearRigsBtn.addEventListener('click', ()=> userRigsLayer.clearLayers());
showAllBtn.addEventListener('click', ()=>{
  FILTER = { operators:new Set(), text:'', radius:{center:null, miles:0}};
  if(radiusCircle){ map.removeLayer(radiusCircle); radiusCircle = null; }
  searchBox.value = '';
  for(const opt of opSelect.options) opt.selected = false;
  document.querySelectorAll('[data-radius]').forEach(b => b.classList.remove('active'));
  drawRuns(); fitToAll();
});

// Export
exportRigs.addEventListener('click', ()=>{
  downloadCsv('apex_rigs.csv', APEX_RIGS.map(r=>({RIG:r.RIG, LAT:r.LAT, LONG:r.LONG})));
});
exportRuns.addEventListener('click', ()=>{
  let rows = ALL_RUNS.slice();
  if(FILTER.operators.size) rows = rows.filter(d => FILTER.operators.has(d.OPERATOR));
  if(FILTER.text){
    const q = FILTER.text.toLowerCase();
    rows = rows.filter(d => (d.WELL||'').toLowerCase().includes(q) || (d.JOBNUM||'').toLowerCase().includes(q));
  }
  if(FILTER.radius.center && FILTER.radius.miles>0){
    const {lat,lng} = FILTER.radius.center;
    rows = rows.filter(d => haversineMi(lat,lng,d.LAT,d.LONG) <= FILTER.radius.miles);
  }
  downloadCsv('visible_runs.csv', rows);
});

// ---- Boot ----
(function init(){
  const rigsCsv = document.getElementById('apexRigsCsv').textContent.trim();
  const runsCsv = document.getElementById('runsCsv').textContent.trim();
  APEX_RIGS = normalizeRigs(rigsCsv);
  drawApexRigs();
  ALL_RUNS = normalizeRuns(runsCsv);
  populateOperatorSelect();
  drawRuns();
  fitToAll();
})();
</script>
</body>
</html>

