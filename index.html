<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>10.3 Motor Runs Map – Full Dataset</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body{margin:0;font-family:system-ui,sans-serif}
    header{padding:1rem;border-bottom:1px solid #ddd;background:#fff;display:flex;flex-wrap:wrap;gap:1rem;align-items:center}
    #map{height:calc(100vh - 80px)}
    .pill{padding:.3rem .6rem;border:1px solid #ddd;border-radius:99px;cursor:pointer}
    .pill.active{background:#0d6efd;color:#fff}
    .legend{position:absolute;right:10px;bottom:10px;background:#fff;padding:.5rem .75rem;border:1px solid #ddd;border-radius:4px;font-size:.9rem;z-index:1000}
    .swatch{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}
  </style>
</head>
<body>
<header>
  <strong>10.3 Motor Runs Map</strong>
  <span>Radius:
    <button class="pill" data-r="5">5 mi</button>
    <button class="pill active" data-r="10">10 mi</button>
    <button class="pill" data-r="20">20 mi</button>
    <button class="pill" data-r="0">None</button>
  </span>
  <input id="search" placeholder="Search WELL / JOBNUM / OPERATOR" style="padding:.4rem;width:250px">
  <button onclick="document.getElementById('search').value='';draw()">Clear</button>
  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="location.reload()">Reset</button>
</header>

<div id="map"></div>

<div class="legend">
  <div><span class="swatch" style="background:#20c997"></span>Normal run</div>
  <div><span class="swatch" style="background:#fd7e14"></span>MWD failure</div>
  <div><span class="swatch" style="background:#dc3545"></span>Motor failure</div>
</div>

<!-- 1. Load Leaflet first -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- 2. Load D3 second -->
<script src="https://unpkg.com/d3@7/d3.min.js"></script>
<!-- 3. Our code – runs only after D3 is available -->
<script>
const map = L.map('map').setView([31.5, -95], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const runsLayer = L.layerGroup().addTo(map);
let radiusCircle = null;
let allRuns = [];

// This will now work – d3 is fully loaded
d3.csv("Runs.csv").then(rawData => {
  allRuns = rawData.filter(d => d.LAT && d.LONG && d.LAT.trim() !== '' && d.LONG.trim() !== '');
  console.log(`Loaded ${allRuns.length} valid runs`);
  drawRuns();
  map.fitBounds(runsLayer.getBounds().pad(0.2));
}).catch(err => console.error("Failed to load Runs.csv:", err));

function drawRuns() {
  runsLayer.clearLayers();
  let data = allRuns;

  const term = document.getElementById('search').value.toLowerCase();
  if (term) data = data.filter(d => 
    (d.WELL||'').toLowerCase().includes(term) ||
    (d.JOBNUM||'').toLowerCase().includes(term) ||
    (d.OPERATOR||'').toLowerCase().includes(term)
  );

  const radius = +document.querySelector('.pill.active')?.dataset.r || 0;
  if (radius > 0 && radiusCircle) {
    const center = radiusCircle.getLatLng();
    data = data.filter(d => L.latLng(+d.LAT, +d.LONG).distanceTo(center) <= radius * 1609.34);
  }

  data.forEach(d => {
    const color = d.MOTOR_FAILURE === '1' ? '#dc3545' :
                  d.MWD_FAILURE === '1' ? '#fd7e14' : '#20c997';
    L.circleMarker([+d.LAT, +d.LONG], {radius:6, color:'#000', weight:1, fillColor:color, fillOpacity:0.8})
      .bindPopup(`
        <b>${d.OPERATOR}</b><br>
        ${d.WELL}<br>
        Rig: ${d.RIG} • Job: ${d.JOBNUM}<br>
        ${d.DATEIN} → ${d.DATEOUT}<br>
        ROP: ${d.AVG_ROP} ft/hr
      `)
      .addTo(runsLayer);
  });
}

// Radius buttons
document.querySelectorAll('.pill').forEach(btn => btn.onclick = function() {
  document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
  this.classList.add('active');
  const r = +this.dataset.r;
  if (r === 0) { if (radiusCircle) map.removeLayer(radiusCircle); radiusCircle = null; drawRuns(); return; }
  alert(`Click the map to set ${r}-mile radius`);
});

map.on('click', e => {
  const r = +document.querySelector('.pill.active')?.dataset.r || 0;
  if (r > 0) {
    if (radiusCircle) map.removeLayer(radiusCircle);
    radiusCircle = L.circle(e.latlng, {radius: r * 1609.34, color:'#0d6efd', fill:false}).addTo(map);
    drawRuns();
  }
});

document.getElementById('search').oninput = drawRuns;

function exportCSV() {
  const csv = d3.csvFormat(runsLayer.getLayers().length ? 
    runsLayer.getLayers().map(l => l.options?.runData || {}) : allRuns);
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = '10.3_visible_runs.csv';
  a.click();
}
</script>
</body>
</html>
