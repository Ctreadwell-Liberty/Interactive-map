<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Apex – Rigs + Runs Map (Inline CSV)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflete>
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  header { padding: .75rem 1rem; border-bottom: 1px solid #e5e5e5; display:flex; gap:1rem; align-items: center; flex-wrap: wrap; }
  header .group { display:flex; gap:.5rem; align-items: center; flex-wrap: wrap; }
  label { font-size:.9rem; color:#444; }
  input[type="text"], select, button { font-size: .95rem; padding: .4rem .6rem; }
  select { min-width: 220px; }
  #map { height: calc(100vh - 88px); }
  .legend { position: absolute; right: 10px; bottom: 10px; background: #fff; padding: .5rem .75rem; border: 1px solid #ddd; border-radius: .5rem; font-size:.85rem;}
  .legend div { margin:.15rem 0; }
  .swatch { display:inline-block; width:10px; height:10px; margin-right:.35rem; border-radius:10px; vertical-align: middle; }
  .btn { background: #0d6efd; color:#fff; border:0; border-radius:.35rem; cursor:pointer; }
  .btn:disabled { opacity:.5; cursor:default; }
  .btn-outline { background:#fff; color:#0d6efd; border:1px solid #0d6efd; }
  .btn-gray { background:#f4f4f5; color:#111; border:1px solid #e4e4e7; }
  .pill { padding:.2rem .5rem; border:1px solid #e4e4e7; border-radius:999px; background:#fff; cursor:pointer; }
  .pill.active { background:#0d6efd; color:#fff; border-color:#0d6efd; }
</style>
</head>
<body>
<header>
  <div class="group">
    <strong>Apex Map</strong>
    <label>Radius:</label>
    <button class="pill" data-radius="5">5 mi</button>
    <button class="pill" data-radius="10">10 mi</button>
    <button class="pill" data-radius="15">15 mi</button>
    <button class="pill" data-radius="20">20 mi</button>
    <button class="pill" data-radius="0" title="Clear radius filter">None</button>
  </div>

  <div class="group">
    <label>Search WELL/JOBNUM:</label>
    <input id="searchBox" type="text" placeholder="Type part of well or job…" />
    <button id="searchClear" class="btn btn-outline">Clear</button>
  </div>

  <div class="group">
    <label>Operators:</label>
    <select id="operatorSelect" multiple size="1" title="Choose operators (Ctrl/Cmd+Click for multiple)"></select>
    <button id="opAll" class="btn btn-outline" title="Select all operators">All</button>
    <button id="opNone" class="btn btn-outline" title="Clear operators">None</button>
  </div>

  <div class="group">
    <button id="exportRigs" class="btn btn-gray">Export Rigs</button>
    <button id="exportRuns" class="btn btn-gray">Export Visible Runs CSV</button>
  </div>

  <div class="group">
    <label>Rig name</label><input id="rigName" type="text" size="12" placeholder="e.g. Apex 123" />
    <label>Lat</label><input id="rigLat" type="text" size="8" />
    <label>Lon</label><input id="rigLon" type="text" size="9" />
    <button id="addRig" class="btn">Add Rig</button>
    <button id="clearRigs" class="btn btn-outline">Clear Rigs</button>
    <button id="showAll" class="btn btn-outline" title="Reset filters and show everything">Show All</button>
  </div>
</header>

<div id="map"></div>

<div class="legend">
  <div><span class="swatch" style="background:#20c997"></span>Normal run</div>
  <div><span class="swatch" style="background:#fd7e14"></span>MWD failure</div>
  <div><span class="swatch" style="background:#dc3545"></span>Motor failure</div>
  <div><span class="swatch" style="background:#0d6efd"></span>Apex rig</div>
</div>

<!-- =========  INLINE CSV DATA  ========= -->
<!-- Paste FULL contents of rigs_inline.csv between these tags -->
<script type="text/csv" id="apexRigsCsv">
<!-- PASTE rigs_inline.csv HERE (from the link above) --> 
</script>

<!-- Paste FULL contents of runs_inline.csv between these tags -->
<script type="text/csv" id="runsCsv">
<!-- PASTE runs_inline.csv HERE (from the link above) -->
</script>
<!-- ==================================== -->

<script src="https://unpkg.com/leafleteaflet.js</script>
<script/d3js.org/d3.v7.min.js</script>
<script>
// ---- Config ----
const APEX_ICON_URL = 'img/apex-rig.svg'; // add an icon file at this path

// ---- Map setup ----
const map = L.map('map').setView([32.10, -94.00], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:18, attribution:'© OpenStreetMap contributors'}).addTo(map);

const apexRigsLayer = L.layerGroup().addTo(map);
const userRigsLayer = L.layerGroup().addTo(map);
const runsLayer     = L.layerGroup().addTo(map);
let radiusCircle = null;

// ---- State ----
let ALL_RUNS = [];
let APEX_RIGS = [];
let FILTER = { operators:new Set(), text:'', radius:{ center:null, miles:0 } };

// ---- Utils ----
const milesToMeters = mi => mi * 1609.344;
function toNumber(x){ const v = +x; return Number.isFinite(v) ? v : null; }
function haversineMi(lat1, lon1, lat2, lon2){
  const R = 3958.7613, toRad = d=>d*Math.PI/180;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function downloadCsv(filename, rows){
  const csv = d3.csvFormat(rows);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  URL.revokeObjectURL(a.href);
}

// ---- Icons ----
const apexIcon = L.icon({ iconUrl: APEX_ICON_URL, iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-24] });

// ---- Data normalization ----
function normalizeRigs(csv){
  const rows = d3.csvParse(csv);
  const out = [], seen = new Set();
  rows.forEach(r=>{
    const name = (r.RIG || r['Rig Name/Number'] || '').trim();
    const lat  = toNumber(r.LAT || r['Rig Latitude (WGS84)']);
    const lon  = toNumber(r.LONG || r['Rig Longitude (WGS84)']);
    if(!name || !Number.isFinite(lat) || !Number.isFinite(lon)) return;
    if(seen.has(name)) return; seen.add(name);
    out.push({RIG:name, LAT:lat, LONG:lon});
  });
  return out;
}

function normalizeRuns(csv){
  const rows = d3.csvParse(csv);
  function pick(o, keys){ for(const k of keys){ if(o[k]!==undefined) return o[k]; } }
  const out = rows.map(r=>({
    OPERATOR:(pick(r,['OPERATOR'])||'').trim(),
    RIG:(pick(r,['RIG'])||'').trim(),
    JOBNUM:(pick(r,['JOBNUM'])||'').trim(),
    WELL:(pick(r,['WELL'])||'').trim(),
    STATE:(pick(r,['STATE'])||'').trim(),
    COUNTY:(pick(r,['COUNTY'])||'').trim(),
    DATEIN:(pick(r,['DATEIN'])||'').trim(),
    DATEOUT:(pick(r,['DATEOUT'])||'').trim(),
    TOTAL_DRILL: toNumber(pick(r,['TOTAL DRILL','TOTAL_DRILL'])) ?? 0,
    AVG_ROP:     toNumber(pick(r,['AVG ROP','AVG_ROP'])) ?? null,
    LAT:  toNumber(pick(r,['LAT'])),
    LONG: toNumber(pick(r,['LONG'])),
    MWD_FAILURE:   +(pick(r,['MWD_FAILURE','MWD FAILURE'])||0),
    MOTOR_FAILURE: +(pick(r,['MOTOR_FAILURE','MOTOR FAILURE'])||0),
    NEAREST_RIG: pick(r,['NEAREST_RIG']),
    NEAREST_RIG_MI: toNumber(pick(r,['NEAREST_RIG_MI']))
  })).filter(d => Number.isFinite(d.LAT) && Number.isFinite(d.LONG));

  // If NEAREST_RIG not present, compute on the fly vs APEX_RIGS
  if(out.length && APEX_RIGS.length && !out.some(d => d.NEAREST_RIG_MI!=null)){
    out.forEach(d=>{
      let best = {name:null, dist:1e9};
      for(const r of APEX_RIGS){
        const dist = haversineMi(d.LAT,d.LONG,r.LAT,r.LONG);
        if(dist < best.dist) best = {name:r.RIG, dist};
      }
      d.NEAREST_RIG = best.name; d.NEAREST_RIG_MI = best.dist;
    });
  }
  return out;
}

// ---- Rendering ----
function drawApexRigs(){
  apexRigsLayer.clearLayers();
  APEX_RIGS.forEach(r=>{
    L.marker([r.LAT, r.LONG], {icon:apexIcon, title:r.RIG})
      .bindPopup(`<b>Apex Rig:</b> ${r.RIG}<br>(${r.LAT.toFixed(5)}, ${r.LONG.toFixed(5)})`)
      .addTo(apexRigsLayer);
  });
}
function colorForRun(d){
  if(+d.MOTOR_FAILURE) return '#dc3545';
  if(+d.MWD_FAILURE)   return '#fd7e14';
  return '#20c997';
}
function drawRuns(){
  runsLayer.clearLayers();

  let data = ALL_RUNS.slice();
  if(FILTER.operators.size) {
    data = data.filter(d => FILTER.operators.has(d.OPERATOR));
  }
  const q = (FILTER.text||'').toLowerCase();
  if(q){
    data = data.filter(d => (d.WELL||'').toLowerCase().includes(q) || (d.JOBNUM||'').toLowerCase().includes(q));
  }
  if(FILTER.radius.center && FILTER.radius.miles>0){
    const {lat,lng} = FILTER.radius.center;
    data = data.filter(d => haversineMi(lat,lng,d.LAT,d.LONG) <= FILTER.radius.miles);
  }

  data.forEach(d=>{
    L.circleMarker([d.LAT, d.LONG], { radius:5, color:colorForRun(d), weight:1, fillOpacity:.7 })
      .bindPopup(`
        <b>${d.OPERATOR}</b><br>${d.WELL || '(no well name)'}<br>
        Rig: ${d.RIG || '-'} | AVG ROP: ${d.AVG_ROP ?? '-'}<br>
        ${d.DATEIN || ''} → ${d.DATEOUT || ''}<br>
        Nearest Apex: ${d.NEAREST_RIG || '-'} (${Number.isFinite(+d.NEAREST_RIG_MI) ? (+d.NEAREST_RIG_MI).toFixed(1)+' mi' : '-'})
      `)
      .addTo(runsLayer);
  });

  return data;
}
function fitToAll(){
  const g = L.featureGroup([apexRigsLayer, runsLayer]);
  try { map.fitBounds(g.getBounds().pad(0.1)); } catch(e){}
}

// ---- UI wiring ----
const searchBox    = document.getElementById('searchBox');
const searchClear  = document.getElementById('searchClear');
const opSelect     = document.getElementById('operatorSelect');
const opAll        = document.getElementById('opAll');
const opNone       = document.getElementById('opNone');
const exportRigs   = document.getElementById('exportRigs');
const exportRuns   = document.getElementById('exportRuns');
const addRigBtn    = document.getElementById('addRig');
const clearRigsBtn = document.getElementById('clearRigs');
const showAllBtn   = document.getElementById('showAll');

function populateOperatorSelect(){
  const uniq = [...new Set(ALL_RUNS.map(d=>d.OPERATOR).filter(Boolean))].sort();
  opSelect.innerHTML = '';
  uniq.forEach(op => {
    const opt = document.createElement('option');
    opt.value = op; opt.textContent = op;
    opSelect.appendChild(opt);
  });
}
function readSelectedOperators(){
  const chosen = new Set();
  for(const opt of opSelect.selectedOptions) chosen.add(opt.value);
  FILTER.operators = chosen;
  drawRuns();
}

opSelect.addEventListener('change', readSelectedOperators);
opAll.addEventListener('click',  ()=>{ for(const opt of opSelect.options) opt.selected = true;  readSelectedOperators(); });
opNone.addEventListener('click', ()=>{ for(const opt of opSelect.options) opt.selected = false; readSelectedOperators(); });

searchBox.addEventListener('input', ()=>{ FILTER.text = searchBox.value || ''; drawRuns(); });
searchClear.addEventListener('click', ()=>{ searchBox.value = ''; FILTER.text = ''; drawRuns(); });

// Radius pills
document.querySelectorAll('[data-radius]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const mi = +btn.getAttribute('data-radius');
    document.querySelectorAll('[data-radius]').forEach(b => b.classList.toggle('active', b===btn));
    if(mi===0){
      FILTER.radius = { center:null, miles:0 };
      if(radiusCircle){ map.removeLayer(radiusCircle); radiusCircle = null; }
      drawRuns();
      return;
    }
    alert(`Click the map to set the ${mi} mile radius center.`);
    FILTER.radius.miles = mi;
  });
});

// Map click: set radius center OR prefill Add-Rig
map.on('click', e=>{
  if(FILTER.radius.miles>0){
    FILTER.radius.center = e.latlng;
    if(radiusCircle) map.removeLayer(radiusCircle);
    radiusCircle = L.circle(e.latlng, { radius:milesToMeters(FILTER.radius.miles), color:'#0d6efd' }).addTo(map);
    drawRuns();
  }
  document.getElementById('rigLat').value = e.latlng.lat.toFixed(6);
  document.getElementById('rigLon').value = e.latlng.lng.toFixed(6);
});

// Add Rig / Clear Rigs / Show All
addRigBtn.addEventListener('click', ()=>{
  const name = (document.getElementById('rigName').value || '').trim() || 'User Rig';
  const lat  = toNumber(document.getElementById('rigLat').value);
  const lon  = toNumber(document.getElementById('rigLon').value);
  if(!Number.isFinite(lat) || !Number.isFinite(lon)){ alert('Enter valid Lat/Lon'); return; }
  L.marker([lat, lon], { title:name })
    .bindPopup(`<b>${name}</b><br>(${lat.toFixed(5)}, ${lon.toFixed(5)})`)
    .addTo(userRigsLayer);
});
clearRigsBtn.addEventListener('click', ()=> userRigsLayer.clearLayers());
showAllBtn.addEventListener('click', ()=>{
  FILTER = { operators:new Set(), text:'', radius:{center:null, miles:0}};
  if(radiusCircle){ map.removeLayer(radiusCircle); radiusCircle = null; }
  searchBox.value = '';
  for(const opt of opSelect.options) opt.selected = false;
  document.querySelectorAll('[data-radius]').forEach(b => b.classList.remove('active'));
  drawRuns(); fitToAll();
});

// Export
exportRigs.addEventListener('click', ()=>{
  downloadCsv('apex_rigs.csv', APEX_RIGS.map(r=>({RIG:r.RIG, LAT:r.LAT, LONG:r.LONG})));
});
exportRuns.addEventListener('click', ()=>{
  let rows = ALL_RUNS.slice();
  if(FILTER.operators.size) rows = rows.filter(d => FILTER.operators.has(d.OPERATOR));
  if(FILTER.text){
    const q = FILTER.text.toLowerCase();
    rows = rows.filter(d => (d.WELL||'').toLowerCase().includes(q) || (d.JOBNUM||'').toLowerCase().includes(q));
  }
  if(FILTER.radius.center && FILTER.radius.miles>0){
    const {lat,lng} = FILTER.radius.center;
    rows = rows.filter(d => haversineMi(lat,lng,d.LAT,d.LONG) <= FILTER.radius.miles);
  }
  downloadCsv('visible_runs.csv', rows);
});

// ---- Boot ----
(function init(){
  const rigsCsv = document.getElementById('apexRigsCsv').textContent.trim();
  const runsCsv = document.getElementById('runsCsv').textContent.trim();
  APEX_RIGS = normalizeRigs(rigsCsv);
  drawApexRigs();
  ALL_RUNS = normalizeRuns(runsCsv);
  populateOperatorSelect();
  drawRuns();
  fitToAll();
})();
</script>
</body>
